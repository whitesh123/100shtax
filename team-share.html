<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒ€ì› ì‘ì—… ê´€ë¦¬</title>
    
    <!-- PWA ì„¤ì • -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="íŒ€ì‘ì—…">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .circular-progress {
            transform: rotate(-90deg);
            filter: drop-shadow(0 2px 8px rgba(99, 102, 241, 0.3));
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 640px) {
            h1 {
                font-size: 2rem !important;
            }
            
            .text-4xl {
                font-size: 2rem !important;
            }
            
            .text-3xl {
                font-size: 1.5rem !important;
            }
            
            .text-2xl {
                font-size: 1.25rem !important;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-6 sm:mb-8 animate-fade-in">
            <div class="inline-block bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-transparent bg-clip-text">
                <h1 class="text-3xl sm:text-4xl font-bold mb-2">ğŸ‘¥ íŒ€ ì‘ì—… ê´€ë¦¬</h1>
            </div>
            <p class="text-gray-600 text-xs sm:text-sm">ì‹¤ì‹œê°„ìœ¼ë¡œ ì‘ì—… ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”</p>
        </div>

        <div class="glass-effect rounded-3xl shadow-2xl p-4 sm:p-8 mb-6 animate-fade-in">
            <div id="loadingSection" class="text-center py-20">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600 text-base sm:text-lg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>

            <div id="contentSection" class="hidden">
                <div class="mb-6 sm:mb-8 p-4 sm:p-6 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-2xl border-2 border-indigo-300">
                    <h2 class="text-2xl sm:text-3xl font-bold text-indigo-900 break-words" id="projectTitle">í”„ë¡œì íŠ¸ ë¡œë”© ì¤‘...</h2>
                </div>

                <div class="mb-6 sm:mb-10 p-4 sm:p-8 bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-2xl text-white shadow-xl">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div class="text-center sm:text-left">
                            <h3 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3">ì§„ì²™ë„</h3>
                            <p class="text-base sm:text-lg opacity-90" id="progressText">ë¡œë”© ì¤‘...</p>
                        </div>
                        <div id="progressCircle" class="transform hover:scale-110 transition-transform"></div>
                    </div>
                </div>

                <div id="projectDetails" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 sm:mb-10">
                    <div id="startDateSection" class="hidden p-4 sm:p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl border-2 border-blue-200 shadow-md">
                        <p class="text-xs sm:text-sm font-semibold text-blue-600 mb-2">ğŸ“… ì‹œì‘ì¼</p>
                        <p class="text-base sm:text-lg font-bold text-blue-800 break-words" id="startDate"></p>
                    </div>

                    <div id="deadlineSection" class="hidden p-4 sm:p-6 bg-gradient-to-br from-red-50 to-red-100 rounded-2xl border-2 border-red-200 shadow-md">
                        <p class="text-xs sm:text-sm font-semibold text-red-600 mb-2">â° ì™„ë£Œì‹œí•œ</p>
                        <p class="text-base sm:text-lg font-bold text-red-800 break-words" id="deadline"></p>
                    </div>
                </div>

                <div id="subtasksSection" class="hidden">
                    <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">âœ… ì„¸ë¶€ ì‘ì—…</h3>
                    <div id="subtasksList" class="space-y-3 mb-6 sm:mb-8"></div>
                </div>

                <div id="statusMessage" class="p-4 sm:p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-2xl border-2 border-green-200 shadow-md hidden">
                    <p class="text-center text-lg sm:text-xl font-bold text-green-800">âœ¨ ì‘ì—… ì™„ë£Œ!</p>
                </div>
            </div>

            <div id="errorMessage" class="p-4 sm:p-6 bg-gradient-to-br from-red-50 to-red-100 rounded-2xl border-2 border-red-200 shadow-md hidden">
                <p class="text-center text-base sm:text-lg font-bold text-red-800">âŒ ê³µìœ ëœ ì‘ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <p class="text-center text-xs sm:text-sm text-red-600 mt-2">ë§í¬ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
            </div>
        </div>

        <div class="text-center text-gray-600 text-xs sm:text-sm space-y-2 animate-fade-in">
            <p class="font-medium">âœï¸ ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ ì‘ì—… ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <p class="font-medium">â• ì„¸ë¶€ ì‘ì—…ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <p class="font-medium">ğŸ”„ 5ì´ˆë§ˆë‹¤ ìë™ìœ¼ë¡œ ìµœì‹  ì •ë³´ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
            <p class="font-medium">â˜ï¸ êµ¬ê¸€ ì‹œíŠ¸ì™€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzH7yaKhcRl_RNd74QJzG4MaWyvZSBPRXiHoNjht3lPCYaIjxvJ8arIr9ENNeobw8CB_Q/exec';
        
        let sharedTodo = null;
        let teamShareId = null;
        let allTodos = [];

        function getTeamShareId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        async function loadTodoFromGoogleSheets() {
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                allTodos = await response.json();
                
                if (allTodos && Array.isArray(allTodos)) {
                    const found = allTodos.find(t => t.teamShareId === teamShareId);
                    if (found) {
                        sharedTodo = found;
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Load error:', error);
                return false;
            }
        }

        async function saveToGoogleSheets() {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(allTodos)
                });
                return true;
            } catch (error) {
                console.error('Save error:', error);
                return false;
            }
        }

        async function toggleSubtask(subtaskId) {
            if (!sharedTodo) return;
            
            const subtask = sharedTodo.subtasks.find(st => st.id === subtaskId);
            if (!subtask) return;
            
            subtask.completed = !subtask.completed;
            
            // ëª¨ë“  ì„œë¸ŒíƒœìŠ¤í¬ ì™„ë£Œ ì—¬ë¶€ í™•ì¸
            if (sharedTodo.subtasks.every(st => st.completed)) {
                sharedTodo.completed = true;
            } else {
                sharedTodo.completed = false;
            }
            
            // allTodos ë°°ì—´ì—ì„œë„ ì—…ë°ì´íŠ¸
            const todoIndex = allTodos.findIndex(t => t.teamShareId === teamShareId);
            if (todoIndex !== -1) {
                allTodos[todoIndex] = sharedTodo;
            }
            
            await saveToGoogleSheets();
            render();
        }

        async function addSubtask(input) {
            if (!sharedTodo) return;
            
            const title = input.value.trim();
            if (!title) return;
            
            // subtasks ë°°ì—´ì´ ì—†ìœ¼ë©´ ìƒì„±
            if (!sharedTodo.subtasks) {
                sharedTodo.subtasks = [];
            }
            
            // ìƒˆ ì„¸ë¶€ì‘ì—… ì¶”ê°€
            const newSubtask = {
                id: Date.now(),
                title: title,
                completed: false
            };
            
            sharedTodo.subtasks.push(newSubtask);
            
            // allTodos ë°°ì—´ì—ì„œë„ ì—…ë°ì´íŠ¸
            const todoIndex = allTodos.findIndex(t => t.teamShareId === teamShareId);
            if (todoIndex !== -1) {
                allTodos[todoIndex] = sharedTodo;
            }
            
            input.value = '';
            await saveToGoogleSheets();
            render();
        }

        async function deleteSubtask(subtaskId) {
            if (!sharedTodo) return;
            
            if (!confirm('ì´ ì„¸ë¶€ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            // subtasks ë°°ì—´ì—ì„œ ì œê±°
            sharedTodo.subtasks = sharedTodo.subtasks.filter(st => st.id !== subtaskId);
            
            // ë‚¨ì€ ì„¸ë¶€ì‘ì—…ì´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (sharedTodo.subtasks.length > 0 && sharedTodo.subtasks.every(st => st.completed)) {
                sharedTodo.completed = true;
            } else if (sharedTodo.subtasks.length === 0) {
                sharedTodo.completed = false;
            } else {
                sharedTodo.completed = false;
            }
            
            // allTodos ë°°ì—´ì—ì„œë„ ì—…ë°ì´íŠ¸
            const todoIndex = allTodos.findIndex(t => t.teamShareId === teamShareId);
            if (todoIndex !== -1) {
                allTodos[todoIndex] = sharedTodo;
            }
            
            await saveToGoogleSheets();
            render();
        }

        function getProgress(todo) {
            if (!todo || !todo.subtasks) return 0;
            if (todo.subtasks.length === 0) {
                return todo.completed ? 100 : 0;
            }
            const completed = todo.subtasks.filter(st => st.completed).length;
            return Math.round((completed / todo.subtasks.length) * 100);
        }

        function createCircularProgress(percentage, size = 100) {
            const radius = (size - 16) / 2;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;
            
            let gradientId = `gradient-${Math.random().toString(36).substr(2, 9)}`;
            let color1, color2;
            
            if (percentage < 30) {
                color1 = '#ef4444'; color2 = '#f97316';
            } else if (percentage < 70) {
                color1 = '#f59e0b'; color2 = '#eab308';
            } else if (percentage < 100) {
                color1 = '#22c55e'; color2 = '#10b981';
            } else {
                color1 = '#8b5cf6'; color2 = '#ec4899';
            }

            return `
                <div class="relative" style="width: ${size}px; height: ${size}px;">
                    <svg width="${size}" height="${size}" class="circular-progress">
                        <defs>
                            <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:${color1};stop-opacity:1" />
                                <stop offset="100%" style="stop-color:${color2};stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle cx="${size/2}" cy="${size/2}" r="${radius}" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                        <circle cx="${size/2}" cy="${size/2}" r="${radius}" fill="none" stroke="url(#${gradientId})" stroke-width="8" 
                            stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" stroke-linecap="round" 
                            style="transition: stroke-dashoffset 0.8s ease-in-out;"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-2xl sm:text-3xl font-bold bg-gradient-to-br from-indigo-600 to-purple-600 text-transparent bg-clip-text">${percentage}%</span>
                    </div>
                </div>
            `;
        }

        function render() {
            if (!sharedTodo) {
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('errorMessage').classList.remove('hidden');
                return;
            }

            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('contentSection').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            
            const progress = getProgress(sharedTodo);

            document.getElementById('projectTitle').textContent = sharedTodo.title;
            document.getElementById('progressText').textContent = sharedTodo.completed ? 'âœ¨ ì™„ë£Œë¨!' : `ì§„í–‰ ì¤‘... ${progress}%`;
            document.getElementById('progressCircle').innerHTML = createCircularProgress(progress, 100);

            if (sharedTodo.date) {
                const startDate = new Date(sharedTodo.date + 'T00:00');
                document.getElementById('startDate').textContent = startDate.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'short'
                }) + (sharedTodo.time ? ` ${sharedTodo.time}` : '');
                document.getElementById('startDateSection').classList.remove('hidden');
            } else {
                document.getElementById('startDateSection').classList.add('hidden');
            }

            if (sharedTodo.deadline) {
                const isOverdue = new Date(sharedTodo.deadline + 'T' + (sharedTodo.deadlineTime || '23:59')) < new Date() && !sharedTodo.completed;
                const deadline = new Date(sharedTodo.deadline + 'T00:00');
                const deadlineText = deadline.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'short'
                }) + (sharedTodo.deadlineTime ? ` ${sharedTodo.deadlineTime}` : '');
                
                document.getElementById('deadline').textContent = deadlineText + (isOverdue ? ' âš ï¸ (ê¸°í•œ ì´ˆê³¼)' : '');
                const deadlineSection = document.getElementById('deadlineSection');
                deadlineSection.classList.remove('hidden');
                
                if (isOverdue) {
                    deadlineSection.classList.remove('from-red-50', 'to-red-100', 'border-red-200');
                    deadlineSection.classList.add('from-orange-100', 'to-red-200', 'border-orange-400', 'bg-orange-50');
                }
            } else {
                document.getElementById('deadlineSection').classList.add('hidden');
            }

            if (sharedTodo.subtasks && sharedTodo.subtasks.length > 0) {
                document.getElementById('subtasksSection').classList.remove('hidden');
                document.getElementById('subtasksList').innerHTML = sharedTodo.subtasks.map(subtask => `
                    <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 bg-white rounded-xl shadow-md hover:shadow-lg transition">
                        <button onclick="toggleSubtask(${subtask.id})" 
                            class="flex-shrink-0 w-6 h-6 sm:w-7 sm:h-7 rounded-md flex items-center justify-center transition transform hover:scale-110 ${
                                subtask.completed ? 'bg-green-500' : 'bg-gray-300 hover:bg-gray-400'
                            }">
                            ${subtask.completed ? '<span class="text-white text-sm sm:text-base font-bold">âœ“</span>' : ''}
                        </button>
                        <p class="flex-1 font-medium text-sm sm:text-lg break-words ${subtask.completed ? 'line-through text-gray-400' : 'text-gray-800'}">
                            ${subtask.title}
                        </p>
                        <button onclick="deleteSubtask(${subtask.id})" 
                            class="p-2 text-red-400 hover:text-red-600 transition transform hover:scale-125 flex-shrink-0" title="ì‚­ì œ">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                `).join('') + `
                    <div class="mt-4">
                        <input type="text" id="newSubtaskInput" placeholder="âœ¨ ì„¸ë¶€ ì‘ì—… ì¶”ê°€..." 
                            onkeypress="if(event.key==='Enter') { addSubtask(this); }"
                            class="w-full px-4 py-3 font-medium border-2 border-indigo-200 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition text-sm sm:text-base">
                    </div>
                `;
            } else {
                document.getElementById('subtasksSection').classList.remove('hidden');
                document.getElementById('subtasksList').innerHTML = `
                    <p class="text-center text-gray-400 py-4">ì•„ì§ ì„¸ë¶€ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    <div class="mt-4">
                        <input type="text" id="newSubtaskInput" placeholder="âœ¨ ì„¸ë¶€ ì‘ì—… ì¶”ê°€..." 
                            onkeypress="if(event.key==='Enter') { addSubtask(this); }"
                            class="w-full px-4 py-3 font-medium border-2 border-indigo-200 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition text-sm sm:text-base">
                    </div>
                `;
            }

            if (progress === 100 && sharedTodo.completed) {
                document.getElementById('statusMessage').classList.remove('hidden');
            } else {
                document.getElementById('statusMessage').classList.add('hidden');
            }
        }

        async function updateData() {
            await loadTodoFromGoogleSheets();
            render();
        }

        setInterval(updateData, 5000);

        teamShareId = getTeamShareId();
        if (teamShareId) {
            updateData();
        } else {
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('errorMessage').classList.remove('hidden');
        }
    </script>
</body>
</html>
