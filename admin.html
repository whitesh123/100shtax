<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í• ì¼ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .circular-progress {
            transform: rotate(-90deg);
            filter: drop-shadow(0 2px 8px rgba(99, 102, 241, 0.3));
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .share-modal.active {
            display: flex;
        }

        .share-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            z-index: 999;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .sync-status.syncing {
            display: flex;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
        }

        .sync-status.success {
            display: flex;
            background: linear-gradient(135deg, #10b981, #22c55e);
            color: white;
        }

        .sync-status.error {
            display: flex;
            background: linear-gradient(135deg, #ef4444, #f97316);
            color: white;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-4 sm:p-8">
    <div id="syncStatus" class="sync-status"></div>

    <div class="max-w-5xl mx-auto">
        <div class="text-center mb-8 animate-fade-in">
            <div class="inline-block bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-transparent bg-clip-text">
                <h1 class="text-5xl font-bold mb-2">âœ¨ í• ì¼ ê´€ë¦¬</h1>
            </div>
            <p class="text-gray-600 text-sm">ë‹¹ì‹ ì˜ ìƒì‚°ì„±ì„ ê·¹ëŒ€í™”í•˜ì„¸ìš”</p>
        </div>

        <div class="glass-effect rounded-3xl shadow-2xl p-8 mb-6 animate-fade-in">
            <div class="mb-10 p-8 bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-2xl text-white shadow-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold mb-3">ì „ì²´ ì§„ì²™ë„</h2>
                        <p class="text-lg opacity-90" id="totalProgressText">0ê°œì˜ í• ì¼ ì¤‘ 0ê°œ ì™„ë£Œ</p>
                    </div>
                    <div id="totalProgressCircle" class="transform hover:scale-110 transition-transform"></div>
                </div>
            </div>

            <div class="mb-8">
                <button id="archiveToggle" class="flex items-center gap-3 px-6 py-3 rounded-xl transition font-medium shadow-lg bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 hover:from-purple-200 hover:to-pink-200 transform hover:scale-105">
                    <span class="text-xl">ğŸ“¦</span>
                    <span>ê³¼ê±° ì™„ë£Œì‘ì—… ë³´ê¸° (<span id="archiveCount">0</span>)</span>
                </button>
            </div>

            <div id="archiveSection" class="mb-8 p-6 bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl hidden border-2 border-purple-200">
                <h3 class="text-xl font-bold text-purple-800 mb-4 flex items-center gap-2">
                    <span>ğŸ“¦</span> ê³¼ê±° ì™„ë£Œì‘ì—…
                </h3>
                <div id="archiveList"></div>
            </div>

            <div class="mb-10 space-y-5 p-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl">
                <input type="text" id="titleInput" placeholder="âœï¸ í• ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" 
                    class="w-full px-6 py-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition text-lg font-medium">
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3 ml-1">ğŸ“… ì‹œì‘ì¼ì‹œ (ì„ íƒ)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="date" id="dateInput" 
                            class="px-6 py-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition">
                        <input type="time" id="timeInput" 
                            class="px-6 py-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3 ml-1">â° ì™„ë£Œì‹œí•œ (ì„ íƒ)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="date" id="deadlineInput" 
                            class="px-6 py-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-pink-500 focus:ring-4 focus:ring-pink-100 transition">
                        <input type="time" id="deadlineTimeInput" 
                            class="px-6 py-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-pink-500 focus:ring-4 focus:ring-pink-100 transition">
                    </div>
                </div>

                <button id="addBtn" class="w-full bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white py-4 rounded-xl hover:from-indigo-700 hover:via-purple-700 hover:to-pink-700 transition flex items-center justify-center gap-3 font-bold text-lg shadow-xl transform hover:scale-105">
                    <span class="text-xl">â•</span> ì¶”ê°€í•˜ê¸°
                </button>
            </div>

            <div id="todoList" class="space-y-4"></div>
        </div>

        <div class="text-center text-gray-600 text-sm space-y-2 animate-fade-in">
            <p class="font-medium">ğŸ’¡ ì‘ì—… ì™„ë£Œ ì‹œ ëˆˆ ì•„ì´ì½˜ì„ ëˆŒëŸ¬ ë³´ê´€í•  ìˆ˜ ìˆì–´ìš”</p>
            <p class="font-medium">ğŸ“‹ ë³µì‚¬ ë²„íŠ¼ìœ¼ë¡œ ë°˜ë³µ ì‘ì—…ì„ ì‰½ê²Œ ë§Œë“¤ ìˆ˜ ìˆì–´ìš” (ë³µì‚¬ í›„ ìë™ìœ¼ë¡œ ì´ë¦„ ìˆ˜ì • ê°€ëŠ¥)</p>
            <p class="font-medium">âœï¸ ì œëª©ì„ ë”ë¸”í´ë¦­í•˜ê±°ë‚˜ ìˆ˜ì • ë²„íŠ¼ìœ¼ë¡œ ì´ë¦„ì„ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”</p>
            <p class="font-medium">ğŸ“… ìº˜ë¦°ë” ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ êµ¬ê¸€ ìº˜ë¦°ë”ì— ê°„í¸í•˜ê²Œ ì €ì¥í•  ìˆ˜ ìˆì–´ìš”</p>
            <p class="font-medium">ğŸ”— ê° í• ì¼ì˜ ë§í¬ ì•„ì´ì½˜ìœ¼ë¡œ ê³ ê°ì—ê²Œ ê³µìœ í•  ìˆ˜ ìˆì–´ìš”</p>
            <p class="font-medium">â˜ï¸ ëª¨ë“  ë°ì´í„°ëŠ” êµ¬ê¸€ ì‹œíŠ¸ì— ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤</p>
        </div>
    </div>

    <div id="shareModal" class="share-modal">
        <div class="share-modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">í• ì¼ ê³µìœ í•˜ê¸°</h2>
            <p class="text-gray-700 font-semibold mb-3" id="shareTodoTitle"></p>
            <p class="text-gray-600 mb-4">ì´ ë§í¬ë¥¼ ê³ ê°ì—ê²Œ ê³µìœ í•˜ë©´ ì´ í• ì¼ì˜ ì§„ì²™ë„ë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">ê³µìœ  ë§í¬:</label>
                <div class="flex gap-2">
                    <input type="text" id="shareLink" readonly 
                        class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl bg-gray-50 font-mono text-sm focus:outline-none overflow-hidden">
                    <button id="copyBtn" class="px-5 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl hover:from-indigo-600 hover:to-purple-600 transition font-medium whitespace-nowrap">
                        ë³µì‚¬
                    </button>
                </div>
            </div>

            <div id="copyMessage" class="mb-6 p-4 bg-green-50 border-2 border-green-200 rounded-xl hidden">
                <p class="text-sm text-green-800">
                    <strong>âœ… ë³µì‚¬ ì™„ë£Œ!</strong> ì´ì œ ì¹´í†¡ì´ë‚˜ ì´ë©”ì¼ë¡œ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.
                </p>
            </div>

            <div class="mb-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
                <p class="text-sm text-blue-800">
                    <strong>ğŸ’¡ íŒ:</strong> ì´ ë§í¬ë¥¼ ì¹´í†¡, ì´ë©”ì¼ ë“±ìœ¼ë¡œ ê³ ê°ì—ê²Œ ë³´ë‚´ì„¸ìš”. ê³ ê°ì€ ì´ ë§í¬ë¥¼ í´ë¦­í•˜ë©´ ì´ í”„ë¡œì íŠ¸ì˜ ì§„ì²™ë„ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <button id="closeShareModal" class="w-full px-4 py-3 bg-gray-200 text-gray-800 rounded-xl hover:bg-gray-300 transition font-medium">
                ë‹«ê¸°
            </button>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzH7yaKhcRl_RNd74QJzG4MaWyvZSBPRXiHoNjht3lPCYaIjxvJ8arIr9ENNeobw8CB_Q/exec';
        
        let todos = [];
        let expandedTodos = {};
        let showArchive = false;
        let isSyncing = false;
        let editingTodoId = null;

        function showSyncStatus(type, message) {
            const status = document.getElementById('syncStatus');
            status.className = `sync-status ${type}`;
            status.textContent = message;
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    status.classList.remove('success', 'error');
                    status.style.display = 'none';
                }, 3000);
            }
        }

        async function syncToGoogleSheets() {
            if (isSyncing) return;
            
            isSyncing = true;
            showSyncStatus('syncing', 'â˜ï¸ ë™ê¸°í™” ì¤‘...');
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(todos)
                });
                
                showSyncStatus('success', 'âœ… ë™ê¸°í™” ì™„ë£Œ!');
            } catch (error) {
                console.error('Sync error:', error);
                showSyncStatus('error', 'âŒ ë™ê¸°í™” ì‹¤íŒ¨');
            } finally {
                isSyncing = false;
            }
        }

        async function loadFromGoogleSheets() {
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    todos = data;
                    render();
                }
            } catch (error) {
                console.error('Load error:', error);
                loadData();
            }
        }

        function loadData() {
            const saved = localStorage.getItem('todos');
            if (saved) {
                todos = JSON.parse(saved);
                syncToGoogleSheets();
                render();
            }
        }

        function saveData() {
            localStorage.setItem('todos', JSON.stringify(todos));
            syncToGoogleSheets();
        }

        function addTodo() {
            const title = document.getElementById('titleInput').value.trim();
            if (!title) return;

            const todo = {
                id: Date.now(),
                title,
                date: document.getElementById('dateInput').value,
                time: document.getElementById('timeInput').value,
                deadline: document.getElementById('deadlineInput').value,
                deadlineTime: document.getElementById('deadlineTimeInput').value,
                completed: false,
                subtasks: [],
                archived: false,
                completedAt: null,
                shareId: 'share_' + Math.random().toString(36).substr(2, 9)
            };

            todos.push(todo);
            saveData();
            
            document.getElementById('titleInput').value = '';
            document.getElementById('dateInput').value = '';
            document.getElementById('timeInput').value = '';
            document.getElementById('deadlineInput').value = '';
            document.getElementById('deadlineTimeInput').value = '';
            
            render();
        }

        function toggleTodo(id) {
            todos = todos.map(todo => {
                if (todo.id === id) {
                    const newCompleted = !todo.completed;
                    return {
                        ...todo,
                        completed: newCompleted,
                        completedAt: newCompleted ? new Date().toISOString() : null,
                        subtasks: todo.subtasks.map(st => ({ ...st, completed: newCompleted }))
                    };
                }
                return todo;
            });
            saveData();
            render();
        }

        function addSubtask(todoId, input) {
            const title = input.value.trim();
            if (!title) return;

            todos = todos.map(todo => {
                if (todo.id === todoId) {
                    return {
                        ...todo,
                        subtasks: [...todo.subtasks, { id: Date.now(), title, completed: false }]
                    };
                }
                return todo;
            });
            
            input.value = '';
            saveData();
            render();
        }

        function toggleSubtask(todoId, subtaskId) {
            todos = todos.map(todo => {
                if (todo.id === todoId) {
                    const updatedSubtasks = todo.subtasks.map(st =>
                        st.id === subtaskId ? { ...st, completed: !st.completed } : st
                    );
                    const allCompleted = updatedSubtasks.length > 0 && updatedSubtasks.every(st => st.completed);
                    return {
                        ...todo,
                        subtasks: updatedSubtasks,
                        completed: allCompleted,
                        completedAt: allCompleted ? new Date().toISOString() : todo.completedAt
                    };
                }
                return todo;
            });
            saveData();
            render();
        }

        function deleteTodo(id) {
            todos = todos.filter(t => t.id !== id);
            saveData();
            render();
        }

        function duplicateTodo(id) {
            const original = todos.find(t => t.id === id);
            if (!original) return;

            const duplicated = {
                ...original,
                id: Date.now(),
                title: original.title + ' (ë³µì‚¬ë³¸)',
                completed: false,
                completedAt: null,
                archived: false,
                shareId: 'share_' + Math.random().toString(36).substr(2, 9),
                subtasks: original.subtasks.map(st => ({
                    ...st,
                    id: Date.now() + Math.random(),
                    completed: false
                }))
            };

            todos.push(duplicated);
            saveData();
            editingTodoId = duplicated.id;
            render();
        }

        function startEditTitle(id) {
            editingTodoId = id;
            render();
        }

        function saveEditTitle(id, input) {
            const newTitle = input.value.trim();
            if (newTitle) {
                todos = todos.map(t => t.id === id ? { ...t, title: newTitle } : t);
                saveData();
            }
            editingTodoId = null;
            render();
        }

        function cancelEditTitle() {
            editingTodoId = null;
            render();
        }

        function deleteSubtask(todoId, subtaskId) {
            todos = todos.map(todo => {
                if (todo.id === todoId) {
                    return {
                        ...todo,
                        subtasks: todo.subtasks.filter(st => st.id !== subtaskId)
                    };
                }
                return todo;
            });
            saveData();
            render();
        }

        function archiveTodo(id) {
            todos = todos.map(t => t.id === id ? { ...t, archived: true } : t);
            saveData();
            render();
        }

        function unarchiveTodo(id) {
            todos = todos.map(t => t.id === id ? { ...t, archived: false } : t);
            saveData();
            render();
        }

        function toggleExpanded(id) {
            expandedTodos[id] = !expandedTodos[id];
            render();
        }

        function openShareModal(todoId) {
            const todo = todos.find(t => t.id === todoId);
            if (!todo) return;
            
            const baseURL = window.location.href.split('?')[0].replace(/admin\.html|index\.html|$/, '');
            const shareURL = baseURL + 'share-todo.html?id=' + todo.shareId;
            
            document.getElementById('shareTodoTitle').textContent = 'ğŸ“Œ ' + todo.title;
            document.getElementById('shareLink').value = shareURL;
            document.getElementById('copyMessage').classList.add('hidden');
            document.getElementById('shareModal').classList.add('active');
        }

        function getProgress(todo) {
            if (todo.subtasks.length === 0) {
                return todo.completed ? 100 : 0;
            }
            const completed = todo.subtasks.filter(st => st.completed).length;
            return Math.round((completed / todo.subtasks.length) * 100);
        }

        function getTotalProgress() {
            const activeTodos = todos.filter(t => !t.archived);
            if (activeTodos.length === 0) return 0;
            const totalProgress = activeTodos.reduce((sum, todo) => sum + getProgress(todo), 0);
            return Math.round(totalProgress / activeTodos.length);
        }

        function createCircularProgress(percentage, size = 60) {
            const radius = (size - 16) / 2;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;
            
            let gradientId = `gradient-${Math.random().toString(36).substr(2, 9)}`;
            let color1, color2;
            
            if (percentage < 30) {
                color1 = '#ef4444'; color2 = '#f97316';
            } else if (percentage < 70) {
                color1 = '#f59e0b'; color2 = '#eab308';
            } else if (percentage < 100) {
                color1 = '#22c55e'; color2 = '#10b981';
            } else {
                color1 = '#8b5cf6'; color2 = '#ec4899';
            }

            return `
                <div class="relative" style="width: ${size}px; height: ${size}px;">
                    <svg width="${size}" height="${size}" class="circular-progress">
                        <defs>
                            <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:${color1};stop-opacity:1" />
                                <stop offset="100%" style="stop-color:${color2};stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle cx="${size/2}" cy="${size/2}" r="${radius}" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                        <circle cx="${size/2}" cy="${size/2}" r="${radius}" fill="none" stroke="url(#${gradientId})" stroke-width="8" 
                            stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" stroke-linecap="round" 
                            style="transition: stroke-dashoffset 0.8s ease-in-out;"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-base font-bold bg-gradient-to-br from-indigo-600 to-purple-600 text-transparent bg-clip-text">${percentage}%</span>
                    </div>
                </div>
            `;
        }

        function addToCalendar(todo) {
            if (!todo.date && !todo.deadline) {
                alert('ì‹œì‘ì¼ì‹œ ë˜ëŠ” ì™„ë£Œì‹œí•œì´ ì„¤ì •ë˜ì§€ ì•Šì€ í• ì¼ì…ë‹ˆë‹¤.');
                return;
            }

            const startDateStr = todo.date || todo.deadline;
            const startTimeStr = todo.time || todo.deadlineTime || '09:00';
            const startDate = new Date(`${startDateStr}T${startTimeStr}`);
            
            let endDate;
            if (todo.deadline) {
                const deadlineTimeStr = todo.deadlineTime || '23:59';
                endDate = new Date(`${todo.deadline}T${deadlineTimeStr}`);
            } else {
                endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
            }
            
            const formatDateTime = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const startStr = formatDateTime(startDate);
            const endStr = formatDateTime(endDate);
            
            let description = 'í• ì¼ê´€ë¦¬ ì•±ì—ì„œ ì¶”ê°€ëœ ì¼ì •';
            if (todo.deadline && todo.date) {
                const deadlineStr = new Date(todo.deadline + 'T00:00').toLocaleDateString('ko-KR');
                description += `\\nì™„ë£Œì‹œí•œ: ${deadlineStr}${todo.deadlineTime ? ' ' + todo.deadlineTime : ''}`;
            }
            
            const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(todo.title)}&dates=${startStr}/${endStr}&details=${encodeURIComponent(description)}`;
            window.open(url, '_blank');
        }

        function render() {
            const activeTodos = todos.filter(t => !t.archived);
            const archivedTodos = todos.filter(t => t.archived).sort((a, b) => 
                new Date(b.completedAt) - new Date(a.completedAt)
            );

            const totalProgress = getTotalProgress();
            const completedCount = activeTodos.filter(t => getProgress(t) === 100).length;
            document.getElementById('totalProgressText').textContent = 
                `${activeTodos.length}ê°œì˜ í• ì¼ ì¤‘ ${completedCount}ê°œ ì™„ë£Œ`;
            document.getElementById('totalProgressCircle').innerHTML = createCircularProgress(totalProgress, 100);

            document.getElementById('archiveCount').textContent = archivedTodos.length;

            if (archivedTodos.length === 0) {
                document.getElementById('archiveList').innerHTML = 
                    '<p class="text-center text-gray-400 py-8 text-lg">ì•„ì§ ë³´ê´€ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                document.getElementById('archiveList').innerHTML = archivedTodos.map(todo => `
                    <div class="bg-white p-4 rounded-xl flex items-center justify-between mb-3 shadow-md hover:shadow-lg transition">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-500 line-through">${todo.title}</p>
                            ${todo.completedAt ? `<p class="text-xs text-gray-400 mt-1">âœ… ì™„ë£Œ: ${new Date(todo.completedAt).toLocaleString('ko-KR')}</p>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="unarchiveTodo(${todo.id})" class="px-4 py-2 text-sm font-medium bg-gradient-to-r from-indigo-100 to-purple-100 text-indigo-700 rounded-lg hover:from-indigo-200 hover:to-purple-200 transition transform hover:scale-105">
                                ë³µì›
                            </button>
                            <button onclick="deleteTodo(${todo.id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition transform hover:scale-110">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            if (activeTodos.length === 0) {
                document.getElementById('todoList').innerHTML = 
                    '<div class="text-center text-gray-400 py-20"><p class="text-2xl mb-2">ğŸ“</p><p class="text-xl font-medium">í• ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p></div>';
            } else {
                document.getElementById('todoList').innerHTML = activeTodos.map(todo => {
                    const progress = getProgress(todo);
                    const isExpanded = expandedTodos[todo.id];
                    const isOverdue = todo.deadline && 
                        new Date(todo.deadline + 'T' + (todo.deadlineTime || '23:59')) < new Date() && 
                        !todo.completed;

                    return `
                        <div class="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-all transform hover:scale-[1.01] animate-fade-in">
                            <div class="p-5 hover:bg-gradient-to-br hover:from-gray-50 hover:to-gray-100 transition">
                                <div class="flex items-start gap-4">
                                    <button onclick="toggleTodo(${todo.id})" 
                                        class="mt-1 flex-shrink-0 w-7 h-7 rounded-lg border-3 flex items-center justify-center transition transform hover:scale-110 shadow-md ${
                                            todo.completed ? 'bg-gradient-to-br from-green-400 to-emerald-500 border-green-500' : 'border-gray-300 hover:border-green-500 bg-white'
                                        }">
                                        ${todo.completed ? '<span class="text-white font-bold">âœ“</span>' : ''}
                                    </button>

                                    <button onclick="toggleExpanded(${todo.id})" 
                                        class="mt-1 flex-shrink-0 text-gray-400 hover:text-indigo-600 transition transform hover:scale-125 text-lg">
                                        ${isExpanded ? 'â–¼' : 'â–¶'}
                                    </button>

                                    <div class="flex-1 min-w-0">
                                        ${editingTodoId === todo.id ? `
                                            <input type="text" value="${todo.title}" 
                                                id="editInput${todo.id}"
                                                onkeypress="if(event.key==='Enter') { saveEditTitle(${todo.id}, this); }"
                                                onblur="cancelEditTitle()"
                                                class="w-full px-3 py-2 text-lg font-semibold border-2 border-indigo-500 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-100"
                                                autofocus>
                                        ` : `
                                            <p class="font-semibold text-lg ${todo.completed ? 'line-through text-gray-400' : 'text-gray-800'}" 
                                                ondblclick="startEditTitle(${todo.id})">
                                                ${todo.title}
                                            </p>
                                        `}
                                        <div class="text-sm text-gray-600 mt-2 space-y-1 font-medium">
                                            ${(todo.date || todo.time) ? `
                                                <p class="flex items-center gap-2">
                                                    <span class="text-lg">ğŸ“…</span>
                                                    ì‹œì‘: ${todo.date ? new Date(todo.date + 'T00:00').toLocaleDateString('ko-KR', {month: 'long', day: 'numeric'}) : ''}
                                                    ${todo.time || ''}
                                                </p>
                                            ` : ''}
                                            ${todo.deadline ? `
                                                <p class="flex items-center gap-2 ${isOverdue ? 'text-red-600 font-bold' : ''}">
                                                    <span class="text-lg">â°</span>
                                                    ì™„ë£Œì‹œí•œ: ${new Date(todo.deadline + 'T00:00').toLocaleDateString('ko-KR', {month: 'long', day: 'numeric'})}
                                                    ${todo.deadlineTime || ''}
                                                    ${isOverdue ? ' (ê¸°í•œ ì´ˆê³¼!)' : ''}
                                                </p>
                                            ` : ''}
                                        </div>
                                    </div>

                                    <div class="transform hover:scale-110 transition-transform">
                                        ${createCircularProgress(progress, 60)}
                                    </div>

                                    <div class="flex gap-2">
                                        <button onclick="openShareModal(${todo.id})" 
                                            class="p-3 text-indigo-600 hover:bg-indigo-50 rounded-xl transition transform hover:scale-110 shadow-md" title="ê³µìœ í•˜ê¸°">
                                            ğŸ”—
                                        </button>
                                        <button onclick="duplicateTodo(${todo.id})" 
                                            class="p-3 text-blue-600 hover:bg-blue-50 rounded-xl transition transform hover:scale-110 shadow-md" title="ë³µì‚¬í•˜ê¸°">
                                            ğŸ“‹
                                        </button>
                                        ${progress === 100 ? `
                                            <button onclick="archiveTodo(${todo.id})" 
                                                class="p-3 text-purple-600 hover:bg-purple-50 rounded-xl transition transform hover:scale-110 shadow-md" title="ë³´ê´€í•˜ê¸°">
                                                ğŸ‘ï¸â€ğŸ—¨ï¸
                                            </button>
                                        ` : ''}
                                        ${(todo.date || todo.deadline) ? `
                                            <button onclick='addToCalendar(${JSON.stringify(todo).replace(/'/g, "&apos;")})' 
                                                class="p-3 text-green-600 hover:bg-green-50 rounded-xl transition transform hover:scale-110 shadow-md" title="ìº˜ë¦°ë”ì— ì¶”ê°€">
                                                ğŸ“…
                                            </button>
                                        ` : ''}
                                        <button onclick="deleteTodo(${todo.id})" 
                                            class="p-3 text-red-600 hover:bg-red-50 rounded-xl transition transform hover:scale-110 shadow-md" title="ì‚­ì œ">
                                            ğŸ—‘ï¸
                                        </button>
                                    </div>
                                </div>
                            </div>

                            ${isExpanded ? `
                                <div class="px-5 pb-5 bg-gradient-to-br from-indigo-50 to-purple-50 border-t-2 border-indigo-200">
                                    <div class="pt-4 space-y-3">
                                        ${todo.subtasks.map(subtask => `
                                            <div class="flex items-center gap-3 ml-11 p-2 bg-white rounded-lg shadow-sm hover:shadow-md transition">
                                                <button onclick="toggleSubtask(${todo.id}, ${subtask.id})" 
                                                    class="flex-shrink-0 w-6 h-6 rounded-md border-2 flex items-center justify-center transition transform hover:scale-110 ${
                                                        subtask.completed ? 'bg-gradient-to-br from-indigo-400 to-purple-500 border-indigo-500' : 'border-gray-300 hover:border-indigo-500 bg-white'
                                                    }">
                                                    ${subtask.completed ? '<span class="text-white text-xs font-bold">âœ“</span>' : ''}
                                                </button>
                                                <p class="flex-1 font-medium ${subtask.completed ? 'line-through text-gray-400' : 'text-gray-700'}">
                                                    ${subtask.title}
                                                </p>
                                                <button onclick="deleteSubtask(${todo.id}, ${subtask.id})" 
                                                    class="p-1 text-red-400 hover:text-red-600 transition transform hover:scale-125">
                                                    ğŸ—‘ï¸
                                                </button>
                                            </div>
                                        `).join('')}
                                        <div class="ml-11 mt-4">
                                            <input type="text" placeholder="âœ¨ ì„¸ë¶€ ëª©ë¡ ì¶”ê°€..." 
                                                onkeypress="if(event.key==='Enter') { addSubtask(${todo.id}, this); }"
                                                class="w-full px-4 py-3 font-medium border-2 border-indigo-200 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition">
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }
        }

        document.getElementById('addBtn').addEventListener('click', addTodo);
        document.getElementById('titleInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTodo();
        });

        document.getElementById('archiveToggle').addEventListener('click', () => {
            showArchive = !showArchive;
            const section = document.getElementById('archiveSection');
            const btn = document.getElementById('archiveToggle');
            
            if (showArchive) {
                section.classList.remove('hidden');
                btn.classList.remove('bg-gradient-to-r', 'from-purple-100', 'to-pink-100', 'text-purple-700');
                btn.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-pink-600', 'text-white');
                btn.innerHTML = '<span class="text-xl">ğŸ“¦</span> <span>ê³¼ê±° ì™„ë£Œì‘ì—… ë‹«ê¸° (<span id="archiveCount">' + 
                    todos.filter(t => t.archived).length + '</span>)</span>';
            } else {
                section.classList.add('hidden');
                btn.classList.add('bg-gradient-to-r', 'from-purple-100', 'to-pink-100', 'text-purple-700');
                btn.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-pink-600', 'text-white');
                btn.innerHTML = '<span class="text-xl">ğŸ“¦</span> <span>ê³¼ê±° ì™„ë£Œì‘ì—… ë³´ê¸° (<span id="archiveCount">' + 
                    todos.filter(t => t.archived).length + '</span>)</span>';
            }
        });

        document.getElementById('closeShareModal').addEventListener('click', () => {
            document.getElementById('shareModal').classList.remove('active');
        });

        document.getElementById('copyBtn').addEventListener('click', async () => {
            const link = document.getElementById('shareLink').value;
            try {
                await navigator.clipboard.writeText(link);
                document.getElementById('copyMessage').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('copyMessage').classList.add('hidden');
                }, 3000);
            } catch (err) {
                alert('ë§í¬: ' + link);
            }
        });

        document.getElementById('shareModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('shareModal')) {
                document.getElementById('shareModal').classList.remove('active');
            }
        });

        loadFromGoogleSheets();
    </script>
</body>
</html>